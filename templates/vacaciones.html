{% extends "base.html" %}
{% block content %}

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

:root{
    --bg-main:#0e1116;
    --bg-card:#171b22;
    --bg-soft:#1f252e;
    --accent:#e10600;
    --accent-yellow:#ffcc00;
    --text-main:#f1f1f1;
    --text-muted:#8b949e;
    --border:#2a2f37;
}

/* ====== BASE ====== */
body{
    background: var(--bg-main);
    font-family:'Inter',sans-serif;
    color:var(--text-main);
}

/* ====== CONTENEDOR GENERAL ====== */
.container{
    max-width:1400px;
}

/* ====== CARDS ====== */
.card-custom{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:30px;
    margin-bottom:30px;
    box-shadow:0 5px 25px rgba(0,0,0,.35);
}

/* ====== HEADERS SECCIÓN ====== */
.section-header{
    font-size:1.1rem;
    font-weight:700;
    letter-spacing:.5px;
    margin-bottom:25px;
    padding-bottom:10px;
    border-bottom:1px solid var(--border);
    color:var(--accent-yellow);
}

/* ====== KPI CARDS ====== */
.kpi-card{
    background:var(--bg-soft);
    border:1px solid var(--border);
    border-radius:12px;
    padding:25px;
    transition:.2s;
}

.kpi-card:hover{
    border-color:var(--accent);
    transform:translateY(-3px);
}

.kpi-title{
    font-size:.75rem;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:.8px;
}

.kpi-number{
    font-size:2.5rem;
    font-weight:700;
    margin-top:10px;
}

.kpi-icon{
    font-size:2rem;
    color:var(--accent);
}

/* ====== FORM ====== */
.form-label{
    font-size:.75rem;
    color:var(--text-muted);
    text-transform:uppercase;
}

.form-control{
    background:var(--bg-soft) !important;
    border:1px solid var(--border) !important;
    border-radius:8px !important;
    color:white !important;
}

.form-control:focus{
    border-color:var(--accent) !important;
    box-shadow:0 0 0 2px rgba(225,6,0,.25) !important;
}

.btn-registrar{
    background:var(--accent);
    border:none;
    border-radius:8px;
    padding:10px 25px;
    font-weight:600;
    transition:.2s;
}

.btn-registrar:hover{
    background:#ff1a1a;
}

/* ====== TEAM CARDS ====== */
.team-card{
    background:var(--bg-soft);
    border:1px solid var(--border);
    border-radius:10px;
    padding:15px 20px;
    margin-bottom:10px;
    transition:.2s;
}

.team-card:hover{
    border-color:var(--accent);
}

/* ====== TABLAS ====== */
.table-container{
    overflow-x:auto;
}

.table-oni{
    width:100%;
    border-collapse:collapse;
}

.table-oni thead{
    background:var(--bg-soft);
}

.table-oni th{
    padding:16px;
    font-size:.7rem;
    text-transform:uppercase;
    letter-spacing:.7px;
    color:var(--text-muted);
    border-bottom:1px solid var(--border);
}

.table-oni td{
    padding:16px;
    border-bottom:1px solid var(--border);
    font-size:.9rem;
}

.table-oni tbody tr{
    transition:.15s;
}

.table-oni tbody tr:hover{
    background:rgba(255,255,255,.03);
}

/* ====== BADGES ====== */
.badge-access{
    padding:6px 12px;
    border-radius:20px;
    font-size:.7rem;
    font-weight:600;
}

/* ====== ACCIONES ====== */
.action-btn{
    background:none;
    border:none;
    color:var(--text-muted);
    font-size:1rem;
    transition:.2s;
}

.action-btn:hover{
    color:var(--accent);
}
</style>

<div class="container py-5">

<!-- ===== KPIs ===== -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="kpi-card d-flex justify-content-between align-items-center">
            <div>
                <div class="kpi-title">Vacaciones activas</div>
                <div class="kpi-number">{{ activas|length }}</div>
            </div>
            <div class="kpi-icon"><i class="bi bi-calendar-check"></i></div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="kpi-card d-flex justify-content-between align-items-center">
            <div>
                <div class="kpi-title">Próximas</div>
                <div class="kpi-number" style="color:var(--accent-yellow)">
                    {{ proximas|length }}
                </div>
            </div>
            <div class="kpi-icon" style="color:var(--accent-yellow)">
                <i class="bi bi-hourglass-split"></i>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="kpi-card d-flex justify-content-between align-items-center">
            <div>
                <div class="kpi-title">Días usados (año)</div>
                <div class="kpi-number">{{ total_dias_anual }}</div>
            </div>
            <div class="kpi-icon"><i class="bi bi-bar-chart-line"></i></div>
        </div>
    </div>
</div>

<!-- ===== REGISTRO ===== -->
<div class="card-custom">
    <div class="section-header">Registrar Vacaciones</div>

    <form method="POST" action="{{ url_for('solicitar_vacaciones') }}">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Empleado</label>
                <select name="user_id" class="form-control" required>
                    <option value="">Seleccionar empleado</option>
                    {% for user in usuarios %}
                    <option value="{{ user.id }}">
                        {{ user.nombre }} ({{ user.dias_vacaciones }} días)
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Inicio</label>
                <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" required>
            </div>

            <div class="col-md-3">
                <label class="form-label">Fin</label>
                <input type="date" name="fecha_fin" id="fecha_fin" class="form-control" required>
            </div>

            <div class="col-md-3">
                <label class="form-label">Días</label>
                <input type="number" name="dias" id="dias" class="form-control" readonly>
            </div>

            <div class="col-12 text-end">
                <button type="submit" class="btn btn-registrar">
                    Registrar
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ===== EN CURSO / PRÓXIMAS ===== -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card-custom">
            <div class="section-header">En Curso</div>
            {% if activas %}
                {% for v in activas %}
                <div class="team-card d-flex justify-content-between">
                    <strong>{{ v.user.nombre }}</strong>
                    <span style="color:var(--accent)">
                        {{ v.dias_restantes }} días restantes
                    </span>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No hay vacaciones activas.</p>
            {% endif %}
        </div>
    </div>

    <div class="col-md-6">
        <div class="card-custom">
            <div class="section-header">Próximas</div>
            {% if proximas %}
                {% for v in proximas %}
                <div class="team-card d-flex justify-content-between">
                    <span>{{ v.user.nombre }}</span>
                    <span style="color:var(--accent-yellow)">
                        Faltan {{ v.dias_para_iniciar }} días
                    </span>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No hay vacaciones próximas.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- ===== HISTORIAL ===== -->
<div class="card-custom mt-4">
    <div class="section-header">Historial General</div>

    <div class="table-container">
        <table class="table-oni">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Días</th>
                    <th>Estado</th>
                    <th>Autor</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for v in vacaciones %}
                <tr>
                    <td><strong>{{ v.user.nombre }}</strong></td>
                    <td>{{ v.fecha_inicio }}</td>
                    <td>{{ v.fecha_fin }}</td>
                    <td style="color:var(--accent-yellow); font-weight:600">
                        {{ v.dias_solicitados }}
                    </td>
                    <td>
                        {% if v.estado == "Aprobado" %}
                        <span class="badge-access" style="background:#238636;">Aprobado</span>
                        {% elif v.estado == "Pendiente" %}
                        <span class="badge-access" style="background:var(--accent-yellow); color:black;">Pendiente</span>
                        {% else %}
                        <span class="badge-access" style="background:var(--accent);">Rechazado</span>
                        {% endif %}
                    </td>
                    <td class="text-muted small">{{ v.registrado_por or "-" }}</td>
                    <td>
                        <a href="{{ url_for('edit_vacacion', id=v.id) }}" class="action-btn">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button onclick="eliminarVacacion({{ v.id }})" class="action-btn ms-2">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</div>

<script>
const inicio = document.getElementById("fecha_inicio");
const fin = document.getElementById("fecha_fin");
const diasInput = document.getElementById("dias");

function calcularDias() {
    if (inicio.value && fin.value) {
        const fechaInicio = new Date(inicio.value);
        const fechaFin = new Date(fin.value);
        const diff = (fechaFin - fechaInicio) / (1000 * 60 * 60 * 24) + 1;
        diasInput.value = diff > 0 ? diff : 0;
    }
}

inicio.addEventListener("change", calcularDias);
fin.addEventListener("change", calcularDias);

function eliminarVacacion(id) {
    if (confirm("¿Seguro que deseas eliminar esta vacación?")) {
        window.location.href = "/delete_vacacion/" + id;
    }
}
</script>

{% endblock %}